<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReengKi 관리자 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
    <style>
        /* Responsive layout adjustments only */
        .admin-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .main-content {
            display: flex;
            flex: 1;
        }

        .sidebar {
            transition: transform 0.3s ease;
        }

        .content {
            flex: 1;
            overflow-x: auto;
        }

        .mobile-menu-toggle {
            display: none;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }

        /* Modal z-index fix */
        .modal {
            z-index: 1060 !important;
        }

        .modal-backdrop {
            z-index: 1055 !important;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .main-content {
                position: relative;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 999;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.show {
                display: block;
            }

            .content {
                width: 100%;
                padding: 1rem;
            }
        }

        /* Small mobile adjustments */
        @media (max-width: 576px) {
            .content {
                padding: 0.75rem;
            }
        }
        
        /* Upload progress styling */
        #uploadProgressSection {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
        }
        
        #uploadProgressBar {
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        #uploadProgressText {
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .progress {
            background-color: #e9ecef;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
        }
        
        /* Folder View Styles */
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px;
            padding: 15px;
            min-height: 300px;
        }
        
        .folder-item, .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
            background: white;
            border: 1px solid transparent;
        }
        
        .folder-item:hover, .file-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-decoration: none;
            color: inherit;
        }
        
        .folder-item.selected, .file-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .item-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: #6c757d;
            pointer-events: none; /* 아이콘 클릭 방지 */
            user-select: none; /* 텍스트 선택 방지 */
        }
        
        .folder-icon {
            color: #ffc107;
        }
        
        .image-icon {
            color: #28a745;
        }
        
        .video-icon {
            color: #dc3545;
        }
        
        .pdf-icon {
            color: #fd7e14;
        }
        
        .text-icon {
            color: #6f42c1;
        }
        
        .item-name {
            font-size: 0.75rem;
            text-align: center;
            word-break: break-word;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .item-details {
            font-size: 0.65rem;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }
        
        .breadcrumb-item a:hover {
            text-decoration: underline;
        }
        
        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
        }
        
        /* Info Sidebar */
        .info-sidebar {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: white;
            border-left: 1px solid #dee2e6;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1050;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .info-sidebar.open {
            right: 0;
        }
        
        .info-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .info-sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .info-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .info-sidebar-content {
            padding: 1rem;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        /* Playable video styles */
        .playable-video .item-icon {
            position: relative;
        }
        
        .play-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: white;
            border-radius: 50%;
            font-size: 20px;
            color: #0d6efd;
            display: none;
        }
        
        .playable-video:hover .play-overlay {
            display: block;
        }
        
        .playable-video {
            cursor: pointer;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .folder-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }
        
        @media (max-width: 992px) {
            .folder-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .folder-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                padding: 10px;
            }
        }
        
        @media (max-width: 576px) {
            .folder-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .item-icon {
                font-size: 2.5rem;
            }
            
            .item-name {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="header">
            <div class="header-content">
                <button class="btn-icon mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="logo">ReengKi</h1>
                <div class="header-actions">
                    <button class="btn-icon">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="sidebar-overlay" onclick="closeSidebar()"></div>

        <div class="main-content">
            <nav class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/assets">
                                <i class="fas fa-th-large"></i> 에셋 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">
                                <i class="fas fa-home"></i> 대시보드
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">에셋 관리</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshAssets()">
                                <i class="fas fa-sync"></i> 새로고침
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importModal">
                                <i class="fas fa-upload"></i> JSON 가져오기
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportAssets()">
                                <i class="fas fa-download"></i> JSON 내보내기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-12">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchInput" placeholder="파일 및 폴더 검색..." oninput="filterItems()" onkeydown="handleSearchKeydown(event)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" id="clearSearchBtn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchFiles()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Folder View -->
                <div class="card shadow" id="folderView">
                    <div class="card-header py-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <!-- Breadcrumb Navigation -->
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb mb-0" id="breadcrumbNav">
                                        <li class="breadcrumb-item active">Home</li>
                                    </ol>
                                </nav>
                            </div>
                            <div class="col-auto">
                                <span id="itemCount" class="badge bg-secondary">0 items</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Loading Indicator -->
                        <div id="loadingIndicator" class="text-center p-5" style="display: none;">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="text-muted">폴더 구조를 로딩 중...</h5>
                            <p class="text-muted">잠시만 기다려 주세요.</p>
                        </div>
                        
                        <!-- Folder Contents -->
                        <div id="folderContents" class="folder-grid">
                            <!-- Folder and file items will be loaded here -->
                        </div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center p-5" style="display: none;">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">폴더가 비어있습니다</h5>
                            <p class="text-muted">파일을 업로드하거나 새 폴더를 만들어보세요.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>


    <!-- Create Asset Modal -->
    <div class="modal fade" id="createAssetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 에셋 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAssetForm">
                        <!-- 교재 ID (필수) -->
                        <div class="mb-3">
                            <label for="bookId" class="form-label">교재 ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookId" name="book_id" required placeholder="예: J1R, J2O, J1G">
                        </div>

                        <!-- 제목 (필수, 기본값은 파일명) -->
                        <div class="mb-3">
                            <label for="assetTitle" class="form-label">제목 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="assetTitle" name="title" required placeholder="제목을 입력하세요">
                        </div>

                        <!-- 카테고리 (옵션) -->
                        <div class="mb-3">
                            <label for="assetCategory" class="form-label">카테고리</label>
                            <input type="text" class="form-control" id="assetCategory" name="category" placeholder="예: 영어, 과학, 수학">
                        </div>

                        <!-- 표지 이미지 (필수) -->
                        <div class="mb-3">
                            <label class="form-label">표지 이미지 <span class="text-danger">*</span></label>
                            <div class="border rounded p-3">
                                <input type="file" class="form-control mb-2" id="coverImageFile" accept="image/*" required onchange="handleCoverImageChange()">
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i> 
                                    JPG, PNG 형식만 지원됩니다.
                                </div>
                                <div id="coverImagePreview" class="mt-2">
                                    <!-- Preview will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- 비디오 영상 (필수) -->
                        <div class="mb-3">
                            <label class="form-label">비디오 영상 <span class="text-danger">*</span></label>
                            <div class="border rounded p-3">
                                <input type="file" class="form-control mb-2" id="videoFile" accept="video/*" required onchange="handleVideoFileChange()">
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i> 
                                    MP4, AVI, MOV 등의 비디오 파일을 지원합니다.
                                </div>
                                <div id="videoPreview" class="mt-2">
                                    <!-- Video preview will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- 자막 데이터 (옵션) -->
                        <div class="mb-3">
                            <label class="form-label">자막 데이터</label>
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">페이지별 문장을 추가하세요</small>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSubtitleRow()">
                                        <i class="fas fa-plus"></i> 자막 추가
                                    </button>
                                </div>
                                <div id="subtitleContainer">
                                    <!-- Subtitle rows will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Progress Indicator -->
                        <div id="uploadProgressSection" style="display: none;">
                            <div class="border rounded p-3 mb-3">
                                <h6 class="mb-3">업로드 진행 상황</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                                        <span id="uploadProgressText">0%</span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <small id="uploadStatus" class="text-muted">업로드 준비 중...</small>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 업로드 속도: <span id="uploadSpeed">계산 중...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary" form="createAssetForm">에셋 추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">JSON에서 에셋 가져오기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="importForm">
                        <div class="mb-3">
                            <label for="jsonFile" class="form-label">JSON 파일 선택</label>
                            <input type="file" class="form-control" id="jsonFile" name="file" accept=".json">
                        </div>
                        <div class="mb-3">
                            <label for="jsonContent" class="form-label">또는 JSON 내용 붙여넣기</label>
                            <textarea class="form-control" id="jsonContent" name="json_content" rows="10" placeholder="JSON 내용을 여기에 붙여넣으세요..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="importAssets()">가져오기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Asset Modal -->
    <div class="modal fade" id="viewAssetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">에셋 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="assetDetails">
                        <!-- Asset details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Cover Images Modal -->
    <div class="modal fade" id="editCoverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">표지 이미지 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCoverForm">
                        <input type="hidden" id="editCoverAssetId" name="asset_id">
                        
                        <!-- Current covers display -->
                        <div id="coverPreview" class="mb-3">
                            <!-- Cover preview images will be shown here -->
                        </div>
                        
                        <!-- File upload section -->
                        <div class="mb-3">
                            <label class="form-label">새 표지 이미지 업로드</label>
                            <div class="border rounded p-3">
                                <input type="file" class="form-control mb-2" id="coverFileInput" accept="image/*" multiple>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i> 
                                    여러 개의 이미지를 선택할 수 있습니다. JPG, PNG 형식만 지원됩니다.
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="uploadCoverFiles()">
                                    <i class="fas fa-upload"></i> 파일 업로드
                                </button>
                            </div>
                        </div>
                        
                        <!-- Upload progress -->
                        <div id="coverUploadProgress" class="mb-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="small text-muted mt-1" id="coverUploadStatus">업로드 중...</div>
                        </div>
                        
                        <!-- Uploaded files list -->
                        <div id="uploadedCoversList" class="mb-3">
                            <!-- Uploaded files will be shown here -->
                        </div>
                        
                        <!-- Manual path editing (advanced) -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showAdvancedCoverEdit">
                                <label class="form-check-label" for="showAdvancedCoverEdit">
                                    고급: 경로 직접 편집
                                </label>
                            </div>
                            <div id="advancedCoverEdit" style="display: none;" class="mt-2">
                                <label for="editCovers" class="form-label">표지 이미지 경로들 (JSON)</label>
                                <textarea class="form-control" id="editCovers" name="covers" rows="5" placeholder='예: ["cover/1_J1R.png", "cover/2_J1R.png"]'></textarea>
                                <div class="form-text">JSON 배열 형태로 입력해주세요.</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveCoverChanges()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Subtitles Modal -->
    <div class="modal fade" id="editSubtitlesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">자막 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSubtitlesForm">
                        <input type="hidden" id="editSubtitlesAssetId" name="asset_id">
                        <div class="mb-3">
                            <label for="editSubtitles" class="form-label">자막 데이터</label>
                            <textarea class="form-control" id="editSubtitles" name="subtitles" rows="15" placeholder='예: [{"page_num": 1, "sentence_num": 1, "text": "Amazing Animals"}]' required></textarea>
                            <div class="form-text">JSON 배열 형태로 입력해주세요. page_num, sentence_num, text 필드가 필요합니다.</div>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatSubtitlesJson()">
                                <i class="fas fa-magic"></i> JSON 포맷팅
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="validateSubtitlesJson()">
                                <i class="fas fa-check"></i> JSON 검증
                            </button>
                        </div>
                        <div id="subtitlesPreview" class="mb-3">
                            <!-- Subtitles preview will be shown here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveSubtitlesChanges()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit YouTube Links Modal -->
    <div class="modal fade" id="editYouTubeModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">YouTube 링크 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editYouTubeForm">
                        <input type="hidden" id="editYouTubeAssetId" name="asset_id">
                        
                        <!-- Current YouTube links display will be managed below -->
                        
                        <!-- Add new YouTube link section -->
                        <div class="mb-3">
                            <h6>새 YouTube 링크 추가</h6>
                            <div class="border rounded p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">썸네일 이미지 업로드</label>
                                        <input type="file" class="form-control mb-2" id="thumbnailFileInput" accept="image/*">
                                        <div id="thumbnailPreview" class="mb-2">
                                            <!-- Thumbnail preview will be shown here -->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="youtubeUrl" class="form-label">YouTube URL</label>
                                        <input type="url" class="form-control mb-2" id="youtubeUrl" placeholder="https://youtu.be/...">
                                        
                                        <label for="youtubeTitle" class="form-label">제목 (선택사항)</label>
                                        <input type="text" class="form-control mb-2" id="youtubeTitle" placeholder="비디오 제목">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="addYouTubeLink()">
                                    <i class="fas fa-plus"></i> YouTube 링크 추가
                                </button>
                            </div>
                        </div>
                        <!-- Current YouTube links management -->
                        <div class="mb-3">
                            <h6>현재 YouTube 링크들</h6>
                            <div id="currentYouTubeLinks">
                                <!-- Current links will be shown here -->
                            </div>
                        </div>
                        <!-- Upload progress -->
                        <div id="youtubeUploadProgress" class="mb-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="small text-muted mt-1" id="youtubeUploadStatus">업로드 중...</div>
                        </div>
                        
                        <!-- Manual JSON editing (advanced) -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showAdvancedYouTubeEdit">
                                <label class="form-check-label" for="showAdvancedYouTubeEdit">
                                    고급: JSON 직접 편집
                                </label>
                            </div>
                            <div id="advancedYouTubeEdit" style="display: none;" class="mt-2">
                                <label for="editYouTubeLinks" class="form-label">YouTube 링크 데이터 (JSON)</label>
                                <textarea class="form-control" id="editYouTubeLinks" name="youtube_links" rows="10" placeholder='예: [{"thumbnail_file": "thumbnail/J1R_amazing.png", "youtube_url": "https://youtu.be/v-r7AtCFc-w", "title": "J1R Amazing"}]'></textarea>
                                <div class="form-text">JSON 배열 형태로 입력해주세요.</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatYouTubeJson()">
                                        <i class="fas fa-magic"></i> JSON 포맷팅
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="validateYouTubeJson()">
                                        <i class="fas fa-check"></i> JSON 검증
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveYouTubeChanges()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/admin.js"></script>
    <script>
        let currentPath = '';
        let selectedItem = null;

        // Utility function to get cookie value
        function getCookie(name) {
            console.log('Looking for cookie:', name);
            console.log('Document cookies:', document.cookie);
            
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const cookieValue = parts.pop().split(';').shift();
                console.log('Found cookie value:', cookieValue);
                return cookieValue;
            }
            console.log('Cookie not found');
            return null;
        }

        // Mobile navigation functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // Close sidebar when clicking outside or on window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated using auth_status cookie
            const authStatus = getCookie('auth_status');
            console.log('uf', authStatus);
            if (authStatus !== 'authenticated') {
                console.log('Not authenticated, redirecting to login');
                window.location.href = '/login';
                return;
            }
            
            // Wait for Bootstrap to be fully loaded
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded');
                setTimeout(() => {
                    if (typeof bootstrap === 'undefined') {
                        alert('Bootstrap이 로드되지 않았습니다. 페이지를 새로고침해주세요.');
                    }
                }, 1000);
                return;
            }
            
            // 폴더 뷰 초기화
            loadFolderContents(currentPath);
            
            // Setup filter form (only if it exists)
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    applyFilters();
                });
            }
            
            // Add context menu handler for root and second level
            const folderContents = document.getElementById('folderContents');
            if (folderContents) {
                folderContents.addEventListener('contextmenu', function(e) {
                    // Check if we clicked on empty space (not on an item)
                    // Make sure we didn't click on a folder-item or its children
                    if (!e.target.closest('.folder-item')) {
                        // Count path depth (empty = root, one slash = second level)
                        const pathDepth = currentPath ? currentPath.split('/').filter(p => p).length : 0;
                        
                        // Show context menu for root level (depth 0) or second level (depth 1)
                        if (pathDepth === 0 || pathDepth === 1) {
                            e.preventDefault();
                            e.stopPropagation();
                            handleRootContextMenu(e);
                        }
                    }
                });
            }
            
            // Initialize modal event listeners
            initializeModalEventListeners();
            
        });


        function initializeModalEventListeners() {
            // Handle create asset modal
            const createAssetForm = document.getElementById('createAssetForm');
            if (createAssetForm) {
                createAssetForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (typeof createAsset === 'function') {
                        createAsset();
                    }
                });
            }

            // Also add click listener to submit button as fallback
            const submitButton = document.querySelector('button[form="createAssetForm"]');
            if (submitButton) {
                submitButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof createAsset === 'function') {
                        createAsset();
                    }
                });
            }

            // Handle create asset modal cleanup
            const createModalElement = document.getElementById('createAssetModal');
            if (createModalElement) {
                createModalElement.addEventListener('hidden.bs.modal', function() {
                    // Reset form
                    document.getElementById('createAssetForm').reset();
                    // Clear previews
                    document.getElementById('coverImagePreview').innerHTML = '';
                    document.getElementById('videoPreview').innerHTML = '';
                    // Clear subtitle container
                    document.getElementById('subtitleContainer').innerHTML = '';
                    // Hide progress section
                    document.getElementById('uploadProgressSection').style.display = 'none';
                    // Reset progress bar
                    document.getElementById('uploadProgressBar').style.width = '0%';
                    document.getElementById('uploadProgressText').textContent = '0%';
                    // Reset form opacity
                    document.getElementById('createAssetForm').style.opacity = '1';
                    document.getElementById('createAssetForm').style.pointerEvents = 'auto';
                    // Reset submit button
                    const submitButton = createModalElement.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '에셋 추가';
                    }
                    // Reset book ID field
                    const bookIdInput = document.getElementById('bookId');
                    if (bookIdInput) {
                        bookIdInput.readOnly = false;
                        bookIdInput.style.backgroundColor = '';
                    }
                });
            }

            // Also handle import modal
            const importModalElement = document.getElementById('importModal');
            if (importModalElement) {
                importModalElement.addEventListener('hidden.bs.modal', function() {
                    console.log('Import modal hidden, cleaning up');
                    
                    // Reset import form
                    const importForm = document.getElementById('importForm');
                    if (importForm) {
                        importForm.reset();
                    }

                    // Clean up any stuck backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });
            }
        }



        // Helper function to normalize image URLs
        function normalizeImageUrl(imagePath) {
            if (!imagePath) return '';
            
            // If it's already a full URL (starts with http), return as is
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            // If it starts with /assets, return as is
            if (imagePath.startsWith('/assets')) {
                return imagePath;
            }
            
            // If it starts with assets/, add leading slash
            if (imagePath.startsWith('assets/')) {
                return '/' + imagePath;
            }
            
            // Otherwise, assume it's a relative path in assets folder
            return '/assets/' + imagePath;
        }

        function loadAssets() {
            loadFolderContents(currentPath);
        }

        function loadFolderContents(path = '') {
            const apiUrl = path ? `/api/folders/${encodeURIComponent(path)}` : '/api/folders';
            
            // 로딩 상태 표시
            showLoadingState();
            
            API.get(apiUrl)
                .then(data => {
                    hideLoadingState();
                    renderFolderView(data);
                    updateBreadcrumbs(data.breadcrumbs);
                    updateItemCount(data.items.length);
                    
                    // Apply filter if search term exists
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    if (searchTerm) {
                        filterItems();
                    }
                })
                .catch(error => {
                    hideLoadingState();
                    console.error('Failed to load folder contents:', error);
                    Notification.error('폴더 내용을 불러오는데 실패했습니다: ' + error.message);
                });
        }
        
        function showLoadingState() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('folderContents').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }
        
        function hideLoadingState() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('folderContents').style.display = 'grid';
        }

        function renderFolderView(data) {
            const folderContents = document.getElementById('folderContents');
            const emptyState = document.getElementById('emptyState');
            
            if (!data.items || data.items.length === 0) {
                folderContents.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            folderContents.innerHTML = '';
            
            data.items.forEach(item => {
                const itemElement = createItemElement(item);
                folderContents.appendChild(itemElement);
            });
        }

        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = item.item_type === 'folder' ? 'folder-item' : 'file-item';
            div.dataset.path = item.path;
            div.dataset.type = item.item_type;
            
            // Add special class for MP4 files
            if (item.item_type === 'file' && item.name && item.name.toLowerCase().endsWith('.mp4')) {
                div.classList.add('playable-video');
            }
            
            const icon = getItemIcon(item);
            const details = getItemDetails(item);
            
            // Add play icon overlay for MP4 files
            const playOverlay = (item.item_type === 'file' && item.name && item.name.toLowerCase().endsWith('.mp4')) 
                ? '<div class="play-overlay"><i class="fas fa-play-circle"></i></div>' 
                : '';
            
            div.innerHTML = `
                <div class="item-icon ${getIconClass(item)}">${icon}${playOverlay}</div>
                <div class="item-name" title="${item.name}">${item.name}</div>
                ${details ? `<div class="item-details">${details}</div>` : ''}
            `;
            
            // 클릭 이벤트 - 이벤트 전파 방지
            div.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleItemClick(item);
            });
            
            // 더블클릭 이벤트 - 이벤트 전파 방지
            div.addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleItemDoubleClick(item);
            });
            
            // 우클릭 컨텍스트 메뉴 - 이벤트 전파 방지
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleContextMenu(e, item);
            });
            
            // 아이콘 클릭 시 스크롤 방지
            const iconElement = div.querySelector('.item-icon');
            if (iconElement) {
                iconElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }
            
            return div;
        }

        function getItemIcon(item) {
            if (item.item_type === 'folder') {
                return '<i class="fas fa-folder"></i>';
            }
            
            switch (item.file_type) {
                case 'image':
                    return '<i class="fas fa-file-image"></i>';
                case 'video':
                    return '<i class="fas fa-file-video"></i>';
                case 'pdf':
                    return '<i class="fas fa-file-pdf"></i>';
                case 'text':
                    return '<i class="fas fa-file-alt"></i>';
                default:
                    return '<i class="fas fa-file"></i>';
            }
        }

        function getIconClass(item) {
            if (item.item_type === 'folder') {
                return 'folder-icon';
            }
            
            switch (item.file_type) {
                case 'image':
                    return 'image-icon';
                case 'video':
                    return 'video-icon';
                case 'pdf':
                    return 'pdf-icon';
                case 'text':
                    return 'text-icon';
                default:
                    return '';
            }
        }

        function getItemDetails(item) {
            if (item.item_type === 'folder') {
                return item.children_count ? `${item.children_count} items` : '';
            }
            
            if (item.size) {
                return formatFileSize(item.size);
            }
            
            return '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function handleItemClick(item) {
            // 파일인 경우 적절한 URL로 이동
            if (item.item_type === 'file') {
                // 경로에서 교재 ID와 제목 추출
                const pathParts = item.path.split('/');
                if (pathParts.length >= 3) {
                    const bookId = pathParts[0];
                    const title = pathParts[1];
                    const fileName = item.name;
                    
                    // 영상 파일인지 확인
                    const isVideoFile = item.name.toLowerCase().match(/\.(mp4|mov|avi|mkv|wmv|flv|webm)$/);
                    
                    let targetUrl;
                    if (isVideoFile) {
                        // 영상 파일은 player 경로 사용
                        targetUrl = `https://reengki-assets-r2-worker.reengkigo.workers.dev/player/${bookId}/${title}/${fileName}`;
                    } else {
                        // 기타 파일은 content 경로 사용
                        targetUrl = `https://reengki-assets-r2-worker.reengkigo.workers.dev/content/${bookId}/${title}/${fileName}`;
                    }
                    
                    console.log('Opening URL:', targetUrl);
                    window.open(targetUrl, '_blank');
                    return;
                }
            }
            
            // 기존 선택 로직 (폴더나 영상 파일의 경우)
            const previouslySelected = document.querySelector('.folder-item.selected, .file-item.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }
            
            // 현재 아이템 선택
            const element = document.querySelector(`[data-path="${item.path}"]`);
            if (selectedItem && selectedItem.path === item.path) {
                // 이미 선택된 아이템을 다시 클릭하면 선택 해제
                selectedItem = null;
            } else {
                // 새 아이템 선택
                element.classList.add('selected');
                selectedItem = item;
            }
        }

        function handleItemDoubleClick(item) {
            if (item.item_type === 'folder') {
                navigateToFolder(item.path);
            } else if (item.item_type === 'file' && item.name && item.name.toLowerCase().endsWith('.mp4')) {
                // For MP4 files, open the player
                // Extract book_id from the path (assuming path format: book_id/filename.mp4)
                const pathParts = item.path.split('/');
                if (pathParts.length >= 2) {
                    const bookId = pathParts[0];
                    // Remove .mp4 extension from filename for the title
                    const title = item.name.replace(/\.mp4$/i, '');
                    const playerUrl = `https://reengki-assets-r2-worker.reengkigo.workers.dev/player/${bookId}/${title}/${title}`;
                    window.open(playerUrl, '_blank');
                } else {
                    Notification.warning('MP4 파일의 경로가 올바르지 않습니다.');
                }
            } else if (item.url) {
                window.open(item.url, '_blank');
            }
        }

        function navigateToFolder(path) {
            currentPath = path;
            loadFolderContents(path);
        }

        function updateBreadcrumbs(breadcrumbs) {
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            breadcrumbNav.innerHTML = '';
            
            breadcrumbs.forEach((crumb, index) => {
                const li = document.createElement('li');
                li.className = 'breadcrumb-item';
                
                if (index === breadcrumbs.length - 1) {
                    li.classList.add('active');
                    li.textContent = crumb.name;
                } else {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = crumb.name;
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateToFolder(crumb.path);
                    });
                    li.appendChild(a);
                }
                
                breadcrumbNav.appendChild(li);
            });
        }

        function updateItemCount(count) {
            const itemCount = document.getElementById('itemCount');
            itemCount.textContent = `${count} items`;
        }


        function refreshAssets() {
            // Show loading state for refresh button
            const refreshButton = document.querySelector('button[onclick="refreshAssets()"]');
            if (refreshButton) {
                refreshButton.disabled = true;
                const originalContent = refreshButton.innerHTML;
                refreshButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>새로고침';
                
                // loadAssets will show the main loading indicator, so re-enable button after a short delay
                setTimeout(() => {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = originalContent;
                }, 1000);
            }
            
            loadAssets();
        }

        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const folderItems = document.querySelectorAll('.folder-item');
            const clearBtn = document.getElementById('clearSearchBtn');
            let visibleCount = 0;
            
            // Show/hide clear button
            clearBtn.style.display = searchTerm ? '' : 'none';
            
            // If no search term, show all items
            if (!searchTerm) {
                folderItems.forEach(item => {
                    item.style.display = '';
                    visibleCount++;
                });
                updateItemCount(visibleCount);
                return;
            }
            
            // Filter items based on search term
            folderItems.forEach(item => {
                const itemName = item.querySelector('.item-name');
                if (itemName) {
                    const name = itemName.textContent.toLowerCase();
                    if (name.includes(searchTerm)) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
            
            // Update item count
            updateItemCount(visibleCount);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterItems();
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Escape') {
                clearSearch();
            }
        }

        function searchFiles() {
            // This function is kept for the search button
            filterItems();
        }


        async function exportFolderVideosAsCSV(folder) {
            try {
                // Show loading notification
                Notification.info('비디오 파일 목록을 수집 중입니다...');
                
                // Recursively collect all video files
                const videos = [];
                await collectVideosRecursively(folder.path, videos);
                
                if (videos.length === 0) {
                    Notification.warning('내보낼 비디오 파일이 없습니다.');
                    return;
                }
                
                // Create CSV content
                const csvContent = createVideoCSV(videos);
                
                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${folder.name}_videos_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Notification.success(`${videos.length}개의 비디오 링크를 내보냈습니다.`);
            } catch (error) {
                console.error('Export error:', error);
                Notification.error('내보내기 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        async function collectVideosRecursively(path, videos) {
            try {
                const apiUrl = `/api/folders/${encodeURIComponent(path)}`;
                const response = await API.get(apiUrl);
                
                if (response && response.items) {
                    for (const item of response.items) {
                        if (item.item_type === 'folder') {
                            // Recursively collect from subfolders
                            await collectVideosRecursively(item.path, videos);
                        } else if (item.item_type === 'file' && item.name && item.name.toLowerCase().endsWith('.mp4')) {
                            // Extract book_id and title
                            const pathParts = item.path.split('/');
                            if (pathParts.length >= 2) {
                                const bookId = pathParts[0];
                                const title = item.name.replace(/\.mp4$/i, '');
                                const videoLink = `https://reengki-assets-r2-worker.reengkigo.workers.dev/player/${bookId}/${title}/${title}`;
                                
                                videos.push({
                                    bookId: bookId,
                                    title: title,
                                    videoLink: videoLink
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error collecting videos from path:', path, error);
                throw error;
            }
        }
        
        function createVideoCSV(videos) {
            // CSV header
            let csv = '\uFEFF교재 ID,제목,비디오 링크\n';
            
            // Add video data
            videos.forEach(video => {
                // Escape commas and quotes in fields
                const bookId = escapeCSVField(video.bookId);
                const title = escapeCSVField(video.title);
                const videoLink = escapeCSVField(video.videoLink);
                
                csv += `${bookId},${title},${videoLink}\n`;
            });
            
            return csv;
        }
        
        function escapeCSVField(field) {
            if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                return `"${field.replace(/"/g, '""')}"`;
            }
            return field;
        }

        function deleteItemWithConfirm(item) {
            const itemType = item.item_type === 'folder' ? '폴더' : '파일';
            const message = item.item_type === 'folder' 
                ? `'${item.name}' 폴더를 삭제하시겠습니까?\n폴더 내의 모든 파일도 함께 삭제됩니다.`
                : `'${item.name}' 파일을 삭제하시겠습니까?`;
            
            if (confirm(message)) {
                deleteItem(item);
            }
        }
        
        async function deleteItem(item) {
            try {
                const response = await API.post('/api/delete-item', {
                    key: item.path
                });
                
                if (response.success) {
                    // 성공시 UI 업데이트
                    Notification.success(`${item.name}이(가) 삭제되었습니다.`);
                    
                    // 목록 새로고침
                    loadFolderContents(currentPath);
                } else {
                    throw new Error(response.error || '삭제 실패');
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                Notification.error(`삭제 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        function handleContextMenu(e, item) {
            e.preventDefault();
            
            // 기존 컨텍스트 메뉴 제거
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // 컨텍스트 메뉴 생성
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            
            // 두번째 뎁스 폴더인 경우 정보 메뉴 추가
            const pathDepth = currentPath ? currentPath.split('/').filter(p => p).length : 0;
            if (item.item_type === 'folder' && pathDepth === 1) {
                const infoItem = document.createElement('div');
                infoItem.className = 'context-menu-item';
                infoItem.innerHTML = '<i class="fas fa-info-circle text-info me-2"></i>정보';
                infoItem.onclick = () => {
                    menu.remove();
                    showFolderInfoPanel(item);
                };
                menu.appendChild(infoItem);
            }
            
            // 최상위 폴더인 경우 내보내기 메뉴 추가
            if (item.item_type === 'folder' && currentPath === '') {
                const exportItem = document.createElement('div');
                exportItem.className = 'context-menu-item';
                exportItem.innerHTML = '<i class="fas fa-file-export text-primary me-2"></i>비디오 링크 내보내기';
                exportItem.onclick = () => {
                    menu.remove();
                    exportFolderVideosAsCSV(item);
                };
                menu.appendChild(exportItem);
            }
            
            // 삭제 메뉴 아이템
            const deleteItem = document.createElement('div');
            deleteItem.className = 'context-menu-item';
            deleteItem.innerHTML = '<i class="fas fa-trash text-danger me-2"></i>삭제';
            deleteItem.onclick = () => {
                menu.remove();
                deleteItemWithConfirm(item);
            };
            menu.appendChild(deleteItem);
            
            // 메뉴를 body에 추가
            document.body.appendChild(menu);
            
            // 다른 곳 클릭시 메뉴 닫기
            const closeMenu = (event) => {
                if (!menu.contains(event.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            // 약간의 지연 후 이벤트 리스너 추가 (즉시 닫히는 것 방지)
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        function handleRootContextMenu(e) {
            e.preventDefault();
            
            // 기존 컨텍스트 메뉴 제거
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // 컨텍스트 메뉴 생성
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            
            // 에셋 추가 메뉴 아이템
            const addItem = document.createElement('div');
            addItem.className = 'context-menu-item';
            addItem.innerHTML = '<i class="fas fa-plus text-primary me-2"></i>에셋 추가';
            addItem.onclick = () => {
                menu.remove();
                
                // Get parent folder name if we're in second depth
                const pathDepth = currentPath ? currentPath.split('/').filter(p => p).length : 0;
                let bookId = '';
                
                if (pathDepth === 1) {
                    // Extract the parent folder name as book ID
                    bookId = currentPath.split('/').filter(p => p)[0];
                }
                
                // Show create asset modal
                const modal = new bootstrap.Modal(document.getElementById('createAssetModal'));
                modal.show();
                
                // Auto-fill book ID if we're in second depth
                if (bookId) {
                    setTimeout(() => {
                        const bookIdInput = document.getElementById('bookId');
                        if (bookIdInput) {
                            bookIdInput.value = bookId;
                            bookIdInput.readOnly = true;
                            bookIdInput.style.backgroundColor = '#f8f9fa';
                        }
                    }, 100);
                }
            };
            menu.appendChild(addItem);
            
            // 메뉴를 body에 추가
            document.body.appendChild(menu);
            
            // 다른 곳 클릭시 메뉴 닫기
            const closeMenu = (event) => {
                if (!menu.contains(event.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            // 약간의 지연 후 이벤트 리스너 추가 (즉시 닫히는 것 방지)
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }


        // Asset creation functions
        let subtitleRowCounter = 0;

        // Handle cover image file change
        function handleCoverImageChange() {
            const fileInput = document.getElementById('coverImageFile');
            const previewDiv = document.getElementById('coverImagePreview');
            const titleInput = document.getElementById('assetTitle');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // Auto-generate title from filename if title is empty
                if (!titleInput.value.trim()) {
                    const filename = file.name;
                    const nameWithoutExtension = filename.substring(0, filename.lastIndexOf('.')) || filename;
                    titleInput.value = nameWithoutExtension;
                }
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = `
                        <div class="text-center">
                            <img src="${e.target.result}" alt="표지 미리보기" style="max-width: 200px; max-height: 200px; object-fit: cover;" class="border rounded">
                            <div class="small mt-1">${file.name}</div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '';
            }
        }

        // Handle video file change
        function handleVideoFileChange() {
            const fileInput = document.getElementById('videoFile');
            const previewDiv = document.getElementById('videoPreview');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // Show video info and preview
                const fileSize = (file.size / (1024 * 1024)).toFixed(2); // MB
                const url = URL.createObjectURL(file);
                
                previewDiv.innerHTML = `
                    <div class="text-center">
                        <video controls style="max-width: 300px; max-height: 200px;" class="border rounded">
                            <source src="${url}" type="${file.type}">
                            브라우저가 비디오를 지원하지 않습니다.
                        </video>
                        <div class="small mt-1">${file.name} (${fileSize} MB)</div>
                    </div>
                `;
            } else {
                previewDiv.innerHTML = '';
            }
        }

        // Add subtitle row
        function addSubtitleRow() {
            subtitleRowCounter++;
            const container = document.getElementById('subtitleContainer');
            
            const row = document.createElement('div');
            row.className = 'subtitle-row mb-2 p-2 border rounded';
            row.id = `subtitle-row-${subtitleRowCounter}`;
            row.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <label class="form-label small">페이지</label>
                        <input type="number" class="form-control form-control-sm" name="subtitle_page" min="1" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">문장</label>
                        <input type="number" class="form-control form-control-sm" name="subtitle_sentence" min="1" value="1" required>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label small">텍스트</label>
                        <input type="text" class="form-control form-control-sm" name="subtitle_text" placeholder="자막 내용을 입력하세요" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small">&nbsp;</label>
                        <button type="button" class="btn btn-sm btn-outline-danger d-block" onclick="removeSubtitleRow(${subtitleRowCounter})" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(row);
        }

        // Remove subtitle row
        function removeSubtitleRow(rowId) {
            const row = document.getElementById(`subtitle-row-${rowId}`);
            if (row) {
                row.remove();
            }
        }

        // Helper functions for upload progress
        function updateProgressDisplay(percent, speed, status) {
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const uploadSpeed = document.getElementById('uploadSpeed');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (progressBar && progressText && uploadSpeed && uploadStatus) {
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
                uploadSpeed.textContent = speed;
                uploadStatus.textContent = status;
            }
        }
        
        function resetUploadUI() {
            document.getElementById('uploadProgressSection').style.display = 'none';
            document.getElementById('createAssetForm').style.opacity = '1';
            document.getElementById('createAssetForm').style.pointerEvents = 'auto';
            
            const submitButton = document.querySelector('#createAssetModal button[type=\"submit\"]');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '에셋 추가';
            }
            
            // Reset progress values
            updateProgressDisplay(0, '계산 중...', '업로드 준비 중...');
        }
        
        function handleUploadError(message) {
            console.error('Upload error:', message);
            updateProgressDisplay(0, '오류 발생', message);
            Notification.error(message);
            
            // Reset UI after showing error briefly
            setTimeout(() => {
                resetUploadUI();
            }, 2000);
        }

        // Create asset function with upload progress tracking
        function createAsset() {
            const form = document.getElementById('createAssetForm');
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get form data
            const bookId = document.getElementById('bookId').value.trim();
            const title = document.getElementById('assetTitle').value.trim();
            const category = document.getElementById('assetCategory').value.trim();
            const coverFile = document.getElementById('coverImageFile').files[0];
            const videoFile = document.getElementById('videoFile').files[0];

            // Collect subtitle data
            const subtitleRows = document.querySelectorAll('.subtitle-row');
            const subtitles = [];
            
            subtitleRows.forEach(row => {
                const page = row.querySelector('[name="subtitle_page"]').value;
                const sentence = row.querySelector('[name="subtitle_sentence"]').value;
                const text = row.querySelector('[name="subtitle_text"]').value.trim();
                
                if (page && sentence && text) {
                    subtitles.push({
                        page_num: parseInt(page),
                        sentence_num: parseInt(sentence),
                        text: text
                    });
                }
            });

            // Validate required fields
            if (!bookId || !title || !coverFile || !videoFile) {
                Notification.error('필수 필드를 모두 입력해주세요. (교재 ID, 제목, 표지 이미지, 비디오 파일)');
                return;
            }
            
            // Check individual file size limits before upload
            const maxFileSize = 2 * 1024 * 1024 * 1024; // 2GB
            if (videoFile.size > maxFileSize) {
                Notification.error(`비디오 파일이 너무 큽니다: ${(videoFile.size / (1024 * 1024 * 1024)).toFixed(2)}GB (최대 2GB)`);
                return;
            }
            if (coverFile.size > maxFileSize) {
                Notification.error(`이미지 파일이 너무 큽니다: ${(coverFile.size / (1024 * 1024 * 1024)).toFixed(2)}GB (최대 2GB)`);
                return;
            }

            // Show upload progress section
            document.getElementById('uploadProgressSection').style.display = 'block';
            
            // Hide form to prevent changes during upload
            document.getElementById('createAssetForm').style.opacity = '0.5';
            document.getElementById('createAssetForm').style.pointerEvents = 'none';

            // Disable submit button
            const submitButton = document.querySelector('#createAssetModal button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>업로드 중...';

            // Create FormData for multipart upload
            const formData = new FormData();
            formData.append('book_id', bookId);
            formData.append('title', title);
            formData.append('category', category);
            formData.append('cover_image', coverFile);
            formData.append('video_file', videoFile);
            formData.append('subtitles', JSON.stringify(subtitles));

            // Calculate total file size
            const totalSize = coverFile.size + videoFile.size;
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            document.getElementById('uploadStatus').textContent = `총 ${totalSizeMB}MB 업로드 중...`;

            // Track upload progress
            const startTime = Date.now();
            let lastLoaded = 0;
            let uploadPhase = 'uploading'; // 'uploading', 'processing', 'completed'
            let maxProgressReached = 0;

            // Create XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();
            
            // Set timeout to 10 minutes for large files
            xhr.timeout = 600000; // 600 seconds = 10 minutes
            
            // Initialize progress display
            updateProgressDisplay(0, 'upload', '업로드 시작 중...');
            
            // Add timeout handler
            xhr.addEventListener('timeout', function() {
                console.error('Upload timeout after 10 minutes');
                handleUploadError('업로드 시간 초과 (10분). 파일이 너무 크거나 네트워크가 느립니다.');
            });

            // Update progress during upload
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable && uploadPhase === 'uploading') {
                    // Upload progress should only go up to 95% to leave room for server processing
                    const uploadProgress = Math.min(Math.round((e.loaded / e.total) * 95), 95);
                    maxProgressReached = Math.max(maxProgressReached, uploadProgress);
                    
                    // Calculate upload speed
                    const currentTime = Date.now();
                    const elapsedTime = (currentTime - startTime) / 1000; // seconds
                    const bytesPerSecond = e.loaded / elapsedTime;
                    const speedMBps = (bytesPerSecond / (1024 * 1024)).toFixed(2);
                    
                    // Update status text
                    const uploadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                    const remainingTime = Math.round((e.total - e.loaded) / bytesPerSecond);
                    const remainingMinutes = Math.floor(remainingTime / 60);
                    const remainingSeconds = remainingTime % 60;
                    
                    let statusText = `${uploadedMB}MB / ${totalSizeMB}MB 업로드 중`;
                    if (remainingTime > 0 && e.loaded < e.total) {
                        statusText += ` - 남은 시간: ${remainingMinutes}분 ${remainingSeconds}초`;
                    }
                    
                    updateProgressDisplay(uploadProgress, speedMBps + ' MB/s', statusText);
                    
                    console.log(`Upload progress: ${uploadProgress}% (${e.loaded}/${e.total} bytes)`);
                }
            });
            
            // Handle upload completion (data sent to server)
            xhr.upload.addEventListener('load', function() {
                console.log('Upload completed, waiting for server response...');
                uploadPhase = 'processing';
                updateProgressDisplay(96, '처리 중...', '서버에서 파일을 처리하고 있습니다...');
            });

            // Handle server response
            xhr.addEventListener('load', function() {
                console.log('Server response received:', xhr.status, xhr.responseText);
                
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            // Show completion
                            uploadPhase = 'completed';
                            updateProgressDisplay(100, '완료!', '에셋이 성공적으로 추가되었습니다!');
                            
                            // Wait a bit to show completion, then hide
                            setTimeout(() => {
                                Notification.success('에셋이 성공적으로 추가되었습니다!');
                                
                                // Reset form
                                form.reset();
                                document.getElementById('coverImagePreview').innerHTML = '';
                                document.getElementById('videoPreview').innerHTML = '';
                                document.getElementById('subtitleContainer').innerHTML = '';
                                
                                // Hide modal
                                const modalElement = document.getElementById('createAssetModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) {
                                    modalInstance.hide();
                                }
                                
                                // Refresh assets list
                                loadAssets();
                                
                                console.log('Asset created successfully');
                                resetUploadUI();
                            }, 1500); // Show success for 1.5 seconds
                        } else {
                            handleUploadError('에셋 추가에 실패했습니다: ' + data.message);
                        }
                    } catch (error) {
                        handleUploadError('서버 응답 처리 중 오류 발생');
                    }
                } else {
                    let errorMessage = '업로드 실패: HTTP ' + xhr.status;
                    if (xhr.status === 413) {
                        errorMessage = '파일 크기 제한 초과 (최대 2GB)';
                    } else if (xhr.status === 408) {
                        errorMessage = '요청 시간 초과. 네트워크 연결을 확인하세요.';
                    } else if (xhr.status === 0) {
                        errorMessage = '서버 연결이 끊어졌습니다. 네트워크를 확인하세요.';
                    }
                    handleUploadError(errorMessage);
                }
            });

            // Handle errors
            xhr.addEventListener('error', function(event) {
                console.error('Upload error:', event);
                console.error('XHR readyState:', xhr.readyState);
                console.error('XHR status:', xhr.status);
                console.error('XHR statusText:', xhr.statusText);
                
                let errorMessage = '네트워크 오류가 발생했습니다';
                if (xhr.status === 0) {
                    errorMessage = '서버 연결 실패. 네트워크 연결을 확인하세요.';
                } else if (xhr.status === 413) {
                    errorMessage = '파일이 너무 큽니다. 서버에서 거부되었습니다.';
                } else if (xhr.status >= 500) {
                    errorMessage = '서버 오류가 발생했습니다. 잠시 후 다시 시도하세요.';
                }
                
                handleUploadError(errorMessage);
            });

            // Log upload start
            console.log('Starting upload:', {
                totalSize: totalSizeMB + 'MB',
                coverSize: (coverFile.size / (1024 * 1024)).toFixed(2) + 'MB',
                videoSize: (videoFile.size / (1024 * 1024)).toFixed(2) + 'MB',
                timeout: xhr.timeout / 1000 + ' seconds'
            });
            
            // Send request
            xhr.open('POST', '/api/assets');
            xhr.withCredentials = true;
            
            try {
                xhr.send(formData);
            } catch (error) {
                console.error('Failed to send request:', error);
                handleUploadError('업로드 요청 실패: ' + error.message);
            }
        }


        function applyFilters() {
            const filterForm = document.getElementById('filterForm');
            if (!filterForm) {
                return;
            }
            
            const formData = new FormData(filterForm);
            const params = new URLSearchParams();
            
            if (formData.get('book_id')) params.append('book_id', formData.get('book_id'));
            
            API.get('/api/assets/filter?' + params.toString())
                .then(data => {
                    renderAssetsTable(data.assets || []);
                    updateAssetCount(data.total_found || 0);
                })
                .catch(error => {
                    console.error('Failed to filter assets:', error);
                    Notification.error('에셋 필터링에 실패했습니다: ' + error.message);
                });
        }

        function clearFilters() {
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.reset();
            }
            renderAssetsTable(currentAssets);
            updateAssetCount(currentAssets.length);
        }

        function viewAsset(assetId) {
            const asset = currentAssets.find(a => a.id === assetId);
            if (!asset) {
                Notification.error('에셋을 찾을 수 없습니다');
                return;
            }

            const detailsHtml = `
                <div class="asset-details">
                    <h6>에셋 ID: ${asset.id}</h6>
                    <div class="mb-3">
                        <h6 class="text-primary">교재 ID: ${asset.book_id}</h6>
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">${asset.title}</h6>
                                <p><strong>카테고리:</strong> ${asset.category || '미분류'}</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>표지 이미지:</h6>
                                        ${asset.covers.map(cover => `
                                            <img src="https://r2-api.reengki.com/file?key=${asset.book_id}/${asset.title}/${cover}" alt="표지" class="img-fluid mb-2" style="max-height: 150px;" onerror="this.style.display='none'">
                                        `).join('')}
                                    </div>
                                    <div class="col-md-8">
                                        <h6>자막 데이터 (${asset.subtitles.length}개):</h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            ${asset.subtitles.slice(0, 5).map(sub => `
                                                <div class="mb-1 small">
                                                    페이지 ${sub.page_num}, 문장 ${sub.sentence_num}: ${sub.text}
                                                </div>
                                            `).join('')}
                                            ${asset.subtitles.length > 5 ? `<div class="small text-muted">...외 ${asset.subtitles.length - 5}개</div>` : ''}
                                        </div>
                                        <h6 class="mt-3">YouTube 링크:</h6>
                                        ${asset.youtube_links.map(link => `
                                            <div class="mb-2">
                                                ${link.thumbnail_file ? `<img src="https://r2-api.reengki.com/file?key=${asset.book_id}/${asset.title}/${link.thumbnail_file}" alt="썸네일" style="width: 100px; height: 60px; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                                                <br>
                                                <a href="${link.youtube_url}" target="_blank" class="btn btn-sm btn-outline-danger">
                                                    <i class="fab fa-youtube"></i> ${link.title || 'YouTube에서 보기'}
                                                </a>
                                            </div>
                                        `).join('')}
                                        ${asset.video_url ? `
                                            <h6 class="mt-3">비디오 파일:</h6>
                                            <a href="${asset.video_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-video"></i> 비디오 보기
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('assetDetails').innerHTML = detailsHtml;
            
            // Use Bootstrap's built-in modal trigger
            const modalElement = document.getElementById('viewAssetModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();
            }
        }

        function deleteAsset(assetId) {
            // Find the asset to show details in confirmation
            const asset = currentAssets.find(a => a.id === assetId);
            const assetInfo = asset ? `에셋 ID: ${asset.id}` : `에셋 ID: ${assetId}`;
            
            if (confirm(`정말로 이 에셋을 삭제하시겠습니까?\n${assetInfo}\n\n관련된 모든 파일(이미지, 썸네일)도 함께 삭제됩니다.`)) {
                // Show loading state
                const deleteButton = document.querySelector(`button[onclick="deleteAsset('${assetId}')"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                }

                API.delete('/api/assets/' + assetId)
                    .then(() => {
                        Notification.success('에셋과 관련 파일들이 성공적으로 삭제되었습니다!');
                        
                        // Remove from current assets array for immediate UI update
                        currentAssets = currentAssets.filter(asset => asset.id !== assetId);
                        
                        // Re-render table immediately
                        renderAssetsTable(currentAssets);
                        updateAssetCount(currentAssets.length);
                        
                        // Also refresh from server for consistency
                        setTimeout(() => {
                            loadAssets();
                        }, 500);
                    })
                    .catch(error => {
                        console.error('Failed to delete asset:', error);
                        Notification.error('에셋 삭제에 실패했습니다: ' + error.message);
                        
                        // Re-enable button on error
                        if (deleteButton) {
                            deleteButton.disabled = false;
                            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                        }
                    });
            }
        }


        // Import modal is now handled by Bootstrap data attributes

        function importAssets() {
            const fileInput = document.getElementById('jsonFile');
            const textInput = document.getElementById('jsonContent');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        processImportData(jsonData);
                    } catch (error) {
                        Notification.error('잘못된 JSON 파일입니다: ' + error.message);
                    }
                };
                reader.readAsText(file);
            } else if (textInput.value.trim()) {
                try {
                    const jsonData = JSON.parse(textInput.value);
                    processImportData(jsonData);
                } catch (error) {
                    Notification.error('잘못된 JSON 내용입니다: ' + error.message);
                }
            } else {
                Notification.warning('파일을 선택하거나 JSON 내용을 입력해주세요');
            }
        }

        function processImportData(jsonData) {
            API.post('/api/assets', jsonData)
                .then(data => {
                    Notification.success('에셋이 성공적으로 가져와졌습니다!');
                    
                    // Hide the modal
                    const modalElement = document.getElementById('importModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    document.getElementById('importForm').reset();
                    loadAssets();
                })
                .catch(error => {
                    console.error('Failed to import assets:', error);
                    Notification.error('에셋 가져오기에 실패했습니다: ' + error.message);
                });
        }

        function exportAssets() {
            API.get('/api/assets')
                .then(data => {
                    const jsonData = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'assets_export_' + new Date().toISOString().split('T')[0] + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    Notification.success('에셋이 성공적으로 내보내졌습니다!');
                })
                .catch(error => {
                    console.error('Failed to export assets:', error);
                    Notification.error('에셋 내보내기에 실패했습니다: ' + error.message);
                });
        }

        function uploadCoverImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, 'cover_image', function(response) {
                        document.getElementById('coverImg').value = response.file_path;
                        Notification.success('표지 이미지가 성공적으로 업로드되었습니다!');
                    });
                }
            };
            input.click();
        }

        function uploadVideoImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, 'video_image', function(response) {
                        document.getElementById('videoImg').value = response.file_path;
                        Notification.success('동영상 썸네일이 성공적으로 업로드되었습니다!');
                    });
                }
            };
            input.click();
        }

        function uploadFile(file, type, callback) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', type);

            fetch('/api/upload', {
                method: 'POST',
                credentials: 'include',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    callback(data);
                } else {
                    Notification.error('업로드 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                Notification.error('업로드 실패: ' + error.message);
            });
        }

        // Edit Cover Images Functions
        function editCoverImages(assetId) {
            const asset = currentAssets.find(a => a.id === assetId);
            if (!asset) {
                Notification.error('에셋을 찾을 수 없습니다');
                return;
            }

            document.getElementById('editCoverAssetId').value = assetId;
            document.getElementById('editCovers').value = JSON.stringify(asset.covers, null, 2);
            
            // Show cover preview
            updateCoverPreview(asset);
            
            // Reset upload section
            document.getElementById('coverFileInput').value = '';
            document.getElementById('uploadedCoversList').innerHTML = '';
            
            // Setup advanced toggle
            const advancedCheckbox = document.getElementById('showAdvancedCoverEdit');
            const advancedSection = document.getElementById('advancedCoverEdit');
            advancedCheckbox.onchange = function() {
                advancedSection.style.display = this.checked ? 'block' : 'none';
            };

            const modalElement = document.getElementById('editCoverModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();
        }

        function updateCoverPreview(asset) {
            const previewDiv = document.getElementById('coverPreview');
            if (!asset.covers || asset.covers.length === 0) {
                previewDiv.innerHTML = '<p class="text-muted">표지 이미지가 없습니다.</p>';
                return;
            }

            const previewHtml = asset.covers.map(cover => `
                <div class="d-inline-block m-2">
                    <img src="/asset/${asset.curriculum}/${asset.month}/${cover}?v=${Date.now()}" 
                         alt="표지" 
                         style="width: 100px; height: 100px; object-fit: cover;" 
                         class="border rounded"
                         onerror="this.style.display='none'">
                    <div class="small text-center mt-1">${cover}</div>
                </div>
            `).join('');

            previewDiv.innerHTML = `
                <h6>현재 표지 이미지들:</h6>
                <div>${previewHtml}</div>
            `;
        }

        // Upload cover files function
        function uploadCoverFiles() {
            console.log('uploadCoverFiles() called');
            const fileInput = document.getElementById('coverFileInput');
            const files = fileInput.files;
            
            console.log('Selected files:', files.length);
            
            if (files.length === 0) {
                Notification.warning('업로드할 파일을 선택해주세요');
                return;
            }

            const progressDiv = document.getElementById('coverUploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const statusDiv = document.getElementById('coverUploadStatus');
            const uploadedList = document.getElementById('uploadedCoversList');
            
            progressDiv.style.display = 'block';
            
            let uploadedFiles = [];
            let completedUploads = 0;
            
            Array.from(files).forEach((file, index) => {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/api/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                })
                .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
                .then(data => {
                    completedUploads++;
                    const progress = (completedUploads / files.length) * 100;
                    progressBar.style.width = progress + '%';
                    statusDiv.textContent = `업로드 중... ${completedUploads}/${files.length}`;
                    
                    if (data.success) {
                        console.log('File uploaded successfully:', data.file_path);
                        uploadedFiles.push(data.file_path);
                        
                        // Add to uploaded files list
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'border rounded p-2 mb-2 d-flex align-items-center justify-content-between';
                        fileDiv.innerHTML = `
                            <div class="d-flex align-items-center">
                                <img src="${data.file_path}" alt="업로드된 이미지" style="width: 50px; height: 50px; object-fit: cover;" class="me-2 rounded">
                                <span>${file.name}</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCoverFile('${data.file_path}', this)">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        uploadedList.appendChild(fileDiv);
                    } else {
                        Notification.error(`${file.name} 업로드 실패: ${data.message}`);
                    }
                    
                    if (completedUploads === files.length) {
                        progressDiv.style.display = 'none';
                        if (uploadedFiles.length > 0) {
                            Notification.success(`${uploadedFiles.length}개 파일이 성공적으로 업로드되었습니다`);
                            
                            // Get current covers to maintain existing filenames (overwrite mode)
                            const currentCovers = JSON.parse(document.getElementById('editCovers').value || '[]');
                            
                            // Replace files but keep the existing filenames exactly as they are
                            // The backend will handle moving uploaded files to overwrite existing ones
                            document.getElementById('editCovers').value = JSON.stringify(currentCovers, null, 2);
                            
                            // Show success message indicating files will be replaced
                            console.log('Files will be replaced:', currentCovers);
                        }
                    }
                })
                .catch(error => {
                    completedUploads++;
                    console.error('Upload error for', file.name, ':', error);
                    Notification.error(`${file.name} 업로드 실패: ${error.message}`);
                    
                    if (completedUploads === files.length) {
                        progressDiv.style.display = 'none';
                        console.log('All uploads completed with errors');
                    }
                });
            });
        }
        
        function removeCoverFile(filePath, buttonElement) {
            // Remove from uploaded list
            buttonElement.closest('div').remove();
            
            // Remove from JSON textarea
            const currentCovers = JSON.parse(document.getElementById('editCovers').value || '[]');
            // Extract filename and create cover path
            const filename = filePath.split('/').pop();
            const coverPath = `cover/${filename}`;
            const updatedCovers = currentCovers.filter(cover => cover !== coverPath);
            document.getElementById('editCovers').value = JSON.stringify(updatedCovers, null, 2);
            
            Notification.info('파일이 목록에서 제거되었습니다');
        }

        function saveCoverChanges() {
            const assetId = document.getElementById('editCoverAssetId').value;
            const coversText = document.getElementById('editCovers').value;

            try {
                const covers = JSON.parse(coversText);
                if (!Array.isArray(covers)) {
                    throw new Error('배열 형태가 아닙니다');
                }

                const updateData = {
                    covers: covers
                };

                // Disable save button to prevent double submission
                const saveButton = document.querySelector('#editCoverModal .btn-primary');
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>저장 중...';

                API.put(`/api/assets/${assetId}`, updateData)
                    .then(data => {
                        Notification.success('표지 이미지가 성공적으로 업데이트되었습니다!');
                        
                        // Hide the modal
                        const modalElement = document.getElementById('editCoverModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        modalInstance.hide();
                        
                        // Refresh the assets list
                        loadAssets();
                    })
                    .catch(error => {
                        console.error('Failed to update covers:', error);
                        Notification.error('표지 이미지 업데이트에 실패했습니다: ' + error.message);
                    })
                    .finally(() => {
                        // Re-enable save button
                        saveButton.disabled = false;
                        saveButton.innerHTML = '저장';
                    });

            } catch (error) {
                Notification.error('잘못된 JSON 형식입니다: ' + error.message);
            }
        }

        // Edit Subtitles Functions
        function editSubtitles(assetId) {
            const asset = currentAssets.find(a => a.id === assetId);
            if (!asset) {
                Notification.error('에셋을 찾을 수 없습니다');
                return;
            }

            document.getElementById('editSubtitlesAssetId').value = assetId;
            document.getElementById('editSubtitles').value = JSON.stringify(asset.subtitles, null, 2);
            
            // Show subtitles preview
            updateSubtitlesPreview(asset.subtitles);

            const modalElement = document.getElementById('editSubtitlesModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();
        }

        function updateSubtitlesPreview(subtitles) {
            const previewDiv = document.getElementById('subtitlesPreview');
            if (!subtitles || subtitles.length === 0) {
                previewDiv.innerHTML = '<p class="text-muted">자막 데이터가 없습니다.</p>';
                return;
            }

            const previewHtml = subtitles.slice(0, 10).map(sub => `
                <div class="border-bottom py-1">
                    <small class="text-muted">페이지 ${sub.page_num}, 문장 ${sub.sentence_num}:</small>
                    <div>${sub.text}</div>
                </div>
            `).join('');

            previewDiv.innerHTML = `
                <h6>자막 미리보기 (처음 10개):</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${previewHtml}
                    ${subtitles.length > 10 ? `<div class="text-muted small mt-2">...외 ${subtitles.length - 10}개</div>` : ''}
                </div>
            `;
        }

        function formatSubtitlesJson() {
            const textarea = document.getElementById('editSubtitles');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed, null, 2);
                Notification.success('JSON이 포맷팅되었습니다');
            } catch (error) {
                Notification.error('잘못된 JSON 형식입니다: ' + error.message);
            }
        }

        function validateSubtitlesJson() {
            const textarea = document.getElementById('editSubtitles');
            try {
                const parsed = JSON.parse(textarea.value);
                if (!Array.isArray(parsed)) {
                    throw new Error('배열 형태가 아닙니다');
                }
                
                for (let i = 0; i < parsed.length; i++) {
                    const item = parsed[i];
                    if (!item.page_num || !item.sentence_num || !item.text) {
                        throw new Error(`${i + 1}번째 항목에 필수 필드가 없습니다 (page_num, sentence_num, text 필요)`);
                    }
                }
                
                updateSubtitlesPreview(parsed);
                Notification.success(`${parsed.length}개 자막 항목이 검증되었습니다`);
            } catch (error) {
                Notification.error('검증 실패: ' + error.message);
            }
        }

        function saveSubtitlesChanges() {
            const assetId = document.getElementById('editSubtitlesAssetId').value;
            const subtitlesText = document.getElementById('editSubtitles').value;

            try {
                const subtitles = JSON.parse(subtitlesText);
                if (!Array.isArray(subtitles)) {
                    throw new Error('배열 형태가 아닙니다');
                }

                // Validate subtitle structure
                for (let i = 0; i < subtitles.length; i++) {
                    const item = subtitles[i];
                    if (!item.page_num || !item.sentence_num || !item.text) {
                        throw new Error(`${i + 1}번째 항목에 필수 필드가 없습니다`);
                    }
                }

                const updateData = {
                    subtitles: subtitles
                };

                // Disable save button to prevent double submission
                const saveButton = document.querySelector('#editSubtitlesModal .btn-primary');
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>저장 중...';

                API.put(`/api/assets/${assetId}`, updateData)
                    .then(data => {
                        Notification.success('자막이 성공적으로 업데이트되었습니다!');
                        
                        // Hide the modal
                        const modalElement = document.getElementById('editSubtitlesModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        modalInstance.hide();
                        
                        // Refresh the assets list
                        loadAssets();
                    })
                    .catch(error => {
                        console.error('Failed to update subtitles:', error);
                        Notification.error('자막 업데이트에 실패했습니다: ' + error.message);
                    })
                    .finally(() => {
                        // Re-enable save button
                        saveButton.disabled = false;
                        saveButton.innerHTML = '저장';
                    });

            } catch (error) {
                Notification.error('잘못된 JSON 형식입니다: ' + error.message);
            }
        }

        // Edit YouTube Links Functions
        function editYouTubeLinks(assetId) {
            const asset = currentAssets.find(a => a.id === assetId);
            if (!asset) {
                Notification.error('에셋을 찾을 수 없습니다');
                return;
            }

            document.getElementById('editYouTubeAssetId').value = assetId;
            document.getElementById('editYouTubeLinks').value = JSON.stringify(asset.youtube_links, null, 2);
            
            // Display current YouTube links for management
            displayCurrentYouTubeLinks(asset.youtube_links, asset);
            
            // Reset form inputs
            document.getElementById('thumbnailFileInput').value = '';
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('youtubeTitle').value = '';
            document.getElementById('thumbnailPreview').innerHTML = '';
            
            // Setup advanced toggle
            const advancedCheckbox = document.getElementById('showAdvancedYouTubeEdit');
            const advancedSection = document.getElementById('advancedYouTubeEdit');
            advancedCheckbox.onchange = function() {
                advancedSection.style.display = this.checked ? 'block' : 'none';
            };
            
            // Setup thumbnail preview
            document.getElementById('thumbnailFileInput').onchange = function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('thumbnailPreview').innerHTML = `
                            <img src="${e.target.result}" alt="썸네일 미리보기" style="width: 100px; height: 60px; object-fit: cover;" class="border rounded">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const modalElement = document.getElementById('editYouTubeModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();
        }

        // YouTube preview function removed as requested

        function formatYouTubeJson() {
            const textarea = document.getElementById('editYouTubeLinks');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed, null, 2);
                Notification.success('JSON이 포맷팅되었습니다');
            } catch (error) {
                Notification.error('잘못된 JSON 형식입니다: ' + error.message);
            }
        }

        function validateYouTubeJson() {
            const textarea = document.getElementById('editYouTubeLinks');
            try {
                const parsed = JSON.parse(textarea.value);
                if (!Array.isArray(parsed)) {
                    throw new Error('배열 형태가 아닙니다');
                }
                
                for (let i = 0; i < parsed.length; i++) {
                    const item = parsed[i];
                    if (!item.thumbnail_file || !item.youtube_url) {
                        throw new Error(`${i + 1}번째 항목에 필수 필드가 없습니다 (thumbnail_file, youtube_url 필요)`);
                    }
                    
                    // Validate YouTube URL format
                    if (!item.youtube_url.includes('youtu')) {
                        throw new Error(`${i + 1}번째 항목의 YouTube URL이 유효하지 않습니다`);
                    }
                }
                
                Notification.success(`${parsed.length}개 YouTube 링크가 검증되었습니다`);
            } catch (error) {
                Notification.error('검증 실패: ' + error.message);
            }
        }

        // Preview function removed as requested

        // Display current YouTube links with edit/delete options
        function displayCurrentYouTubeLinks(youtubeLinks, asset) {
            const linksDiv = document.getElementById('currentYouTubeLinks');
            if (!youtubeLinks || youtubeLinks.length === 0) {
                linksDiv.innerHTML = '<p class="text-muted">현재 YouTube 링크가 없습니다.</p>';
                return;
            }

            const linksHtml = youtubeLinks.map((link, index) => `
                <div class="card mb-2" data-index="${index}">
                    <div class="card-body p-2">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                ${link.thumbnail_file ? `
                                    <img src="/asset/${asset.curriculum}/${asset.month}/${link.thumbnail_file}?v=${Date.now()}" 
                                         alt="썸네일" 
                                         style="width: 80px; height: 48px; object-fit: cover;" 
                                         class="border rounded"
                                         onerror="this.style.display='none'">
                                ` : '<div class="bg-light border rounded" style="width: 80px; height: 48px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image text-muted"></i></div>'}
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-1">${link.title || '제목 없음'}</h6>
                                <small class="text-muted">
                                    <a href="${link.youtube_url}" target="_blank" class="text-decoration-none">
                                        <i class="fab fa-youtube text-danger"></i> ${link.youtube_url}
                                    </a>
                                </small>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeYouTubeLink(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            linksDiv.innerHTML = linksHtml;
        }
        
        // Add new YouTube link
        function addYouTubeLink() {
            const thumbnailFile = document.getElementById('thumbnailFileInput').files[0];
            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
            const youtubeTitle = document.getElementById('youtubeTitle').value.trim();
            
            if (!thumbnailFile) {
                Notification.warning('썸네일 이미지를 선택해주세요');
                return;
            }
            
            if (!youtubeUrl) {
                Notification.warning('YouTube URL을 입력해주세요');
                return;
            }
            
            if (!youtubeUrl.includes('youtu')) {
                Notification.warning('올바른 YouTube URL을 입력해주세요');
                return;
            }
            
            // Show upload progress
            const progressDiv = document.getElementById('youtubeUploadProgress');
            const statusDiv = document.getElementById('youtubeUploadStatus');
            progressDiv.style.display = 'block';
            statusDiv.textContent = '썸네일 업로드 중...';
            
            // Upload thumbnail first
            const formData = new FormData();
            formData.append('file', thumbnailFile);
            
            fetch('/api/upload', {
                method: 'POST',
                credentials: 'include',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    // Add to YouTube links
                    const currentLinks = JSON.parse(document.getElementById('editYouTubeLinks').value || '[]');
                    // Convert upload path to thumbnail path relative to curriculum/month folder
                    const filename = data.file_path.split('/').pop();
                    const thumbnailPath = `thumbnail/${filename}`;
                    
                    const newLink = {
                        thumbnail_file: thumbnailPath,
                        youtube_url: youtubeUrl,
                        title: youtubeTitle || '제목 없음'
                    };
                    
                    currentLinks.push(newLink);
                    document.getElementById('editYouTubeLinks').value = JSON.stringify(currentLinks, null, 2);
                    
                    // Update display
                    const assetId = document.getElementById('editYouTubeAssetId').value;
                    const asset = currentAssets.find(a => a.id === assetId);
                    displayCurrentYouTubeLinks(currentLinks, asset);
                    
                    // Reset form
                    document.getElementById('thumbnailFileInput').value = '';
                    document.getElementById('youtubeUrl').value = '';
                    document.getElementById('youtubeTitle').value = '';
                    document.getElementById('thumbnailPreview').innerHTML = '';
                    
                    Notification.success('YouTube 링크가 추가되었습니다');
                } else {
                    Notification.error('썸네일 업로드 실패: ' + data.message);
                }
            })
            .catch(error => {
                progressDiv.style.display = 'none';
                console.error('Upload error:', error);
                Notification.error('썸네일 업로드 실패: ' + error.message);
            });
        }
        
        // Remove YouTube link
        function removeYouTubeLink(index) {
            const currentLinks = JSON.parse(document.getElementById('editYouTubeLinks').value || '[]');
            currentLinks.splice(index, 1);
            document.getElementById('editYouTubeLinks').value = JSON.stringify(currentLinks, null, 2);
            
            // Update display
            const assetId = document.getElementById('editYouTubeAssetId').value;
            const asset = currentAssets.find(a => a.id === assetId);
            displayCurrentYouTubeLinks(currentLinks, asset);
            
            Notification.info('YouTube 링크가 제거되었습니다');
        }

        function saveYouTubeChanges() {
            const assetId = document.getElementById('editYouTubeAssetId').value;
            const youtubeText = document.getElementById('editYouTubeLinks').value;

            try {
                const youtubeLinks = JSON.parse(youtubeText);
                if (!Array.isArray(youtubeLinks)) {
                    throw new Error('배열 형태가 아닙니다');
                }

                // Validate YouTube links structure
                for (let i = 0; i < youtubeLinks.length; i++) {
                    const item = youtubeLinks[i];
                    if (!item.thumbnail_file || !item.youtube_url) {
                        throw new Error(`${i + 1}번째 항목에 필수 필드가 없습니다`);
                    }
                }

                const updateData = {
                    youtube_links: youtubeLinks
                };

                // Disable save button to prevent double submission
                const saveButton = document.querySelector('#editYouTubeModal .btn-primary');
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>저장 중...';

                API.put(`/api/assets/${assetId}`, updateData)
                    .then(data => {
                        Notification.success('YouTube 링크가 성공적으로 업데이트되었습니다!');
                        
                        // Hide the modal
                        const modalElement = document.getElementById('editYouTubeModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        modalInstance.hide();
                        
                        // Refresh the assets list
                        loadAssets();
                    })
                    .catch(error => {
                        console.error('Failed to update YouTube links:', error);
                        Notification.error('YouTube 링크 업데이트에 실패했습니다: ' + error.message);
                    })
                    .finally(() => {
                        // Re-enable save button
                        saveButton.disabled = false;
                        saveButton.innerHTML = '저장';
                    });

            } catch (error) {
                Notification.error('잘못된 JSON 형식입니다: ' + error.message);
            }
        }

        // Show folder info panel as sidebar
        function showFolderInfoPanel(item) {
            console.log('Showing folder info for:', item);
            
            // Extract book ID and title from path
            const pathParts = item.path.split('/').filter(p => p);
            if (pathParts.length < 2) {
                Notification.error('폴더 정보를 가져올 수 없습니다.');
                return;
            }
            
            const bookId = pathParts[0];
            const title = pathParts[1];
            
            // Update sidebar title
            document.getElementById('infoSidebarTitle').textContent = `폴더 정보 - ${title}`;
            
            // Clear all tab contents first
            document.getElementById('videoContent').innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div>';
            document.getElementById('imageContent').innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div>';
            document.getElementById('subtitleContent').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div></div>';
            
            // Reset tabs to default state (video tab active)
            document.querySelectorAll('#folderInfoTabs .nav-link').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            document.getElementById('video-tab').classList.add('active');
            document.getElementById('video-pane').classList.add('show', 'active');
            
            // Show sidebar
            const sidebar = document.getElementById('infoSidebar');
            const overlay = document.getElementById('infoSidebarOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('show');
            
            // Store current bookId and title for tab switching
            sidebar.dataset.bookId = bookId;
            sidebar.dataset.title = title;
            
            // Load video content (default active tab)
            loadVideoContent(bookId, title);
            
            // Remove existing event listeners and add new ones
            const videoTab = document.getElementById('video-tab');
            const imageTab = document.getElementById('image-tab');
            const subtitleTab = document.getElementById('subtitle-tab');
            
            // Clone nodes to remove all event listeners
            const newVideoTab = videoTab.cloneNode(true);
            const newImageTab = imageTab.cloneNode(true);
            const newSubtitleTab = subtitleTab.cloneNode(true);
            
            videoTab.parentNode.replaceChild(newVideoTab, videoTab);
            imageTab.parentNode.replaceChild(newImageTab, imageTab);
            subtitleTab.parentNode.replaceChild(newSubtitleTab, subtitleTab);
            
            // Add fresh event listeners with current bookId and title
            newVideoTab.addEventListener('click', () => {
                console.log('Video tab clicked for:', bookId, title);
                loadVideoContent(bookId, title);
            });
            newImageTab.addEventListener('click', () => {
                console.log('Image tab clicked for:', bookId, title);
                loadImageContent(bookId, title);
            });
            newSubtitleTab.addEventListener('click', () => {
                console.log('Subtitle tab clicked for:', bookId, title);
                loadSubtitleContent(bookId, title);
            });
            
            // Add close event listeners
            document.getElementById('closeInfoSidebar').onclick = closeInfoSidebar;
            document.getElementById('infoSidebarOverlay').onclick = closeInfoSidebar;
        }
        
        // Close info sidebar
        function closeInfoSidebar() {
            const sidebar = document.getElementById('infoSidebar');
            const overlay = document.getElementById('infoSidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // Load video content
        function loadVideoContent(bookId, title) {
            const videoContent = document.getElementById('videoContent');
            videoContent.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div>';
            
            // Find video file
            API.get(`/api/folders/${bookId}/${title}`)
                .then(response => {
                    const videoFile = response.items.find(item => 
                        item.item_type === 'file' && 
                        item.name.toLowerCase().match(/\.(mp4|mov|avi|mkv|wmv|flv|webm)$/)
                    );
                    
                    if (videoFile) {
                        const videoUrl = `https://reengki-assets-r2-worker.reengkigo.workers.dev/player/${bookId}/${title}/${videoFile.name}`;
                        videoContent.innerHTML = `
                            <div class="ratio ratio-16x9" style="max-width: 800px; margin: 0 auto;">
                                <iframe src="${videoUrl}" frameborder="0" allowfullscreen></iframe>
                            </div>
                        `;
                    } else {
                        videoContent.innerHTML = '<div class="alert alert-warning">영상 파일이 없습니다.</div>';
                    }
                })
                .catch(error => {
                    console.error('Video content load error:', error);
                    videoContent.innerHTML = '<div class="alert alert-danger">영상 정보를 불러오는데 실패했습니다.</div>';
                });
        }

        // Load image content  
        function loadImageContent(bookId, title) {
            const imageContent = document.getElementById('imageContent');
            imageContent.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div>';
            
            // Use internal API to get resized image
            const imageUrl = `/api/image/${bookId}/${title}`;
            
            imageContent.innerHTML = `
                <div class="text-center">
                    <img src="${imageUrl}" 
                         class="img-fluid border rounded" 
                         style="max-width: 100%; max-height: 400px; object-fit: contain;" 
                         alt="이미지"
                         onload="this.style.opacity='1'"
                         style="opacity: 0; transition: opacity 0.3s ease;">
                </div>
            `;
        }

        // Load subtitle content
        function loadSubtitleContent(bookId, title) {
            const subtitleContent = document.getElementById('subtitleContent');
            subtitleContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div></div>';
            
            // Use internal API endpoint
            API.get(`/api/subtitle/${bookId}/${title}`)
                .then(response => {
                    console.log('Subtitle API response:', response);
                    
                    if (!response.success) {
                        throw new Error(response.error || '자막 데이터 로드 실패');
                    }
                    
                    const subtitleData = response.data;
                    
                    if (!subtitleData || subtitleData.length === 0) {
                        subtitleContent.innerHTML = '<div class="alert alert-warning">자막 데이터가 없습니다.</div>';
                        return;
                    }
                    
                    // Display subtitle data in a table with proper headers
                    const subtitleHtml = `
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-striped table-hover">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 20%; color: black;">페이지 번호</th>
                                        <th style="width: 20%; color: black;">문장 번호</th>
                                        <th style="width: 60%; color: black;">문장</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subtitleData.map((item, index) => `
                                        <tr>
                                            <td class="text-center">
                                                <span class="badge bg-primary fs-6">${item.page_num || 'N/A'}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary fs-6">${item.sentence_num || 'N/A'}</span>
                                            </td>
                                            <td class="text-start">${item.text || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="text-muted small mt-2">
                                총 ${subtitleData.length}개의 자막 항목
                            </div>
                        </div>
                    `;
                    
                    subtitleContent.innerHTML = subtitleHtml;
                })
                .catch(error => {
                    console.error('Subtitle load error:', error);
                    subtitleContent.innerHTML = '<div class="alert alert-warning">자막 데이터가 없습니다.</div>';
                });
        }
    </script>
    <!-- Info Sidebar -->
    <div class="info-sidebar-overlay" id="infoSidebarOverlay"></div>
    <div class="info-sidebar" id="infoSidebar">
        <div class="info-sidebar-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0" id="infoSidebarTitle">폴더 정보</h5>
            <button type="button" class="btn-close" id="closeInfoSidebar"></button>
        </div>
        <div class="info-sidebar-content">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" id="folderInfoTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button" role="tab">
                        <i class="fas fa-video me-2"></i>영상
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-pane" type="button" role="tab">
                        <i class="fas fa-image me-2"></i>이미지
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="subtitle-tab" data-bs-toggle="tab" data-bs-target="#subtitle-pane" type="button" role="tab">
                        <i class="fas fa-closed-captioning me-2"></i>자막
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="folderInfoTabsContent">
                <!-- Video Tab -->
                <div class="tab-pane fade show active" id="video-pane" role="tabpanel">
                    <div id="videoContent" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩중...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Image Tab -->
                <div class="tab-pane fade" id="image-pane" role="tabpanel">
                    <div id="imageContent" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩중...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Subtitle Tab -->
                <div class="tab-pane fade" id="subtitle-pane" role="tabpanel">
                    <div id="subtitleContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">로딩중...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>